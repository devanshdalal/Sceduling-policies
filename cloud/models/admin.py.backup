def install(pid,vmid=None,chost_id=None,dhost_id=None,parameters=None):
    import sys
    try:
        reqid = parameters.split("|")[1]
        vmname = parameters.split("|")[2]
 
        req = db(db.request.id == reqid).select()[0]
     	datastore=give_datastore()
        vmname=req.vmname
	    vmcount=int(getconstant("defined_vms"))+1
	    if(vmcount%100 ==0): vmcount=vmcount+1
	    setconstant("defined_vms",vmcount)
	    (newmac,newip,vncport)=new_mac_ip(vmcount)
	    print "VMCount="+str(vmcount)+" MAC:"+str(newmac)+" NEW IP:"+newip+" VNCPort:"+vncport
        #Check if a vm with same name already exists
        if namerepcheck(vmname) == False:
            print "Start the process. No vm with the same name exists already in the database"
            machine=db(db.host.id==req.kvmhost).select()[0]
            template = db(db.template.id == req.templateid).select()[0]
            template_hdfile = template.hdfile
                    
            import time,os,commands
            from paramiko import SSHClient, SSHException

            print "Creating directory"
            vm_loc = getconstant('vmfiles_path')+getconstant('datastore_int')+datastore.name+'/'+vmname+'/'+ vmname + '.qcow2'
            template_loc = getconstant('vmfiles_path')+getconstant('datastore_int')+datastore.name+'/'+getconstant('templates_path') + template_hdfile
            if not os.path.exists (getconstant('vmfiles_path')+getconstant('datastore_int')+datastore.name+'/'+vmname):
                os.makedirs(getconstant('vmfiles_path')+getconstant('datastore_int')+datastore.name+'/'+vmname)
            print "Netapp Copy and Move in progress"
            command='sudo ssh '+datastore.ip+' ndmpcopy '+datastore.path+'/'+getconstant("templates_dir")+'/'+template_hdfile+' '+datastore.path+'/'+getconstant("templates_dir")+'/tmp'
	    print command
	    print commands.getstatusoutput(command)
	    command='sudo ssh '+datastore.ip+' mv '+datastore.path+'/'+getconstant("templates_dir")+'/tmp/'+template_hdfile+' '+datastore.path+'/'+vmname+'/'+vmname+'.qcow2'
	    print command
            print commands.getstatusoutput(command)
            optional = ' --import --os-type='+ template.ostype
	    if(template.arch!='amd64'):optional = optional+' --arch='+template.arch+' '
            install_cmd = 'virt-install \
                    --name=' + vmname + ' \
                    --ram=' + str(req.RAM) + ' \
                    --vcpus='+str(req.vCPUs)+optional+' \
                    --disk path=' + vm_loc+',bus=virtio \
                    --network bridge=br0,model=virtio,mac='+newmac+' \
		    --graphics vnc,port='+vncport+',listen=0.0.0.0,password=iitdcloud \
                    --noautoconsole \
                    --description \
                    --autostart \
                    --force'

            print "Installation started"
	    print "Host is "+machine.ip
	    print install_cmd
            out = commands.getstatusoutput("sudo ssh "+machine.ip+" "+install_cmd)
            print out
            print "Check if VM has been successfully created"
            if (checkifvmisdefined(machine.ip,vmname)):

                faculty=db(db.auth_user.username == req.faculty).select(db.auth_user.id)[0]['id']
                db.vm.insert( \
                  userid=faculty, \
                  name=req.vmname, \
                  RAM=req.RAM, \
                  HDD=int(req.HDD)+int(template.hdd), \
                  hostid=machine.id, \
		  datastore=datastore.id, \
                  definedon=machine.id, \
                  mac=newmac,ip=newip,sport=vncport, \
		  laststarttime=currenttime(), \
                  templateid=req.templateid, \
		  runlevel=3, \
                  lastrunlevel=3, \
                  vCPU=req.vCPUs, \
                  purpose=req.purpose, \
                  expire_date=req.expire_date)

                vm=db(db.vm.name==req.vmname).select(db.vm.id)[0]
                db.vmaccpermissions.insert(userid=req.userid, vmid=vm.id)

                count = db(db.host.id == machine.id).select(db.host.vmcount)[0].vmcount
                db(db.host.id==machine.id).update(vmcount=count+1)
                user_id = req.userid
                vm_name = req.vmname
                send_confirmation_email(user_id,vm_name)
                db.logs_request.insert( vmname=req.vmname, userid = req.userid, RAM = req.RAM, expire_date=req.expire_date, HDD = req.HDD, vCPUs = req.vCPUs, templateid = req.templateid, status = 1, \
                purpose = req.purpose, faculty = req.faculty)
                db(db.request.id==req.id).delete()

                vmid=db(db.vm.name == req.vmname).select()[0]['id']
                db(db.queue.id==pid).update(status=1,vm=vmid,ftime=putdate())
		db(db.datastores.id==datastore.id).update(used=int(datastore.used)+int(req.HDD)+int(template.hdd))
            else: 
                db(db.queue.id==pid).update(status=-1,comments="Some Problem occured while executing "+install_cmd+" on host "+machine.ip,ftime=putdate())
        else:
            db(db.queue.id==pid).update(status=-1,comments="VM with same name already exists",ftime=putdate())
    except :
        import traceback
        etype, value, tb = sys.exc_info()
        msg=''.join(traceback.format_exception(etype, value, tb, 10))
        db(db.queue.id==pid).update(status=-1,comments=msg,ftime=putdate())
